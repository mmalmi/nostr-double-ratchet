name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.2.3)'
        required: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (static musl)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          # Linux aarch64 (static musl)
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          # macOS x86_64
          - target: x86_64-apple-darwin
            os: macos-14
            cross: false
          # macOS aarch64 (Apple Silicon)
          - target: aarch64-apple-darwin
            os: macos-14
            cross: false
          # Windows x86_64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            cross: false

    defaults:
      run:
        working-directory: rust

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Build (cross)
        if: matrix.cross
        run: |
          cross build --release --target ${{ matrix.target }} -p ndr

      - name: Build (native)
        if: "!matrix.cross"
        run: |
          cargo build --release --target ${{ matrix.target }} -p ndr

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist/ndr
          cp target/${{ matrix.target }}/release/ndr dist/ndr/

          # Create install script
          cat > dist/ndr/install.sh << 'EOF'
          #!/bin/bash
          set -e

          INSTALL_DIR="${1:-/usr/local/bin}"

          echo "Installing ndr to $INSTALL_DIR"

          if [ ! -w "$INSTALL_DIR" ]; then
            echo "Need sudo to install to $INSTALL_DIR"
            sudo install -m 755 ndr "$INSTALL_DIR/"
          else
            install -m 755 ndr "$INSTALL_DIR/"
          fi

          echo "✓ Installed ndr"
          echo ""
          echo "Verify with:"
          echo "  ndr --help"
          EOF
          chmod +x dist/ndr/install.sh

          # Create README
          cat > dist/ndr/README.txt << 'EOF'
          ndr - Encrypted Nostr messaging (double ratchet)
          ==============================================

          Binary included:
            ndr  - CLI for encrypted Nostr messaging

          Quick install:
            ./install.sh              # installs to /usr/local/bin (may need sudo)
            ./install.sh ~/.local/bin # installs to custom directory

          Manual install:
            cp ndr /usr/local/bin/

          Quick start:
            ndr login <private_key>
            ndr invite create
            ndr chat join <invite_url>
            ndr send <chat_id> "Hello!"
            ndr read <chat_id>

          JSON mode:
            ndr --json whoami
            ndr --json send <chat_id> "Hello from automation"

          More info: https://github.com/mmalmi/nostr-double-ratchet
          EOF

          cd dist
          tar -czvf ndr-${{ matrix.target }}.tar.gz ndr
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum ndr-${{ matrix.target }}.tar.gz > ndr-${{ matrix.target }}.sha256
          else
            shasum -a 256 ndr-${{ matrix.target }}.tar.gz > ndr-${{ matrix.target }}.sha256
          fi
          rm -rf ndr

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist/ndr
          Copy-Item target/${{ matrix.target }}/release/ndr.exe dist/ndr/

          # Create README
          @"
          ndr - Encrypted Nostr messaging (double ratchet)
          ==============================================

          Binary included:
            ndr.exe  - CLI for encrypted Nostr messaging

          Install:
            Copy ndr.exe to a directory in your PATH, e.g.:
            C:\Users\<you>\AppData\Local\Microsoft\WindowsApps\

          Quick start:
            ndr login <private_key>
            ndr invite create
            ndr chat join <invite_url>
            ndr send <chat_id> "Hello!"
            ndr read <chat_id>

          More info: https://github.com/mmalmi/nostr-double-ratchet
          "@ | Out-File -FilePath dist/ndr/README.txt -Encoding UTF8

          Compress-Archive -Path dist/ndr -DestinationPath dist/ndr-${{ matrix.target }}.zip
          $hash = (Get-FileHash dist/ndr-${{ matrix.target }}.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  ndr-${{ matrix.target }}.zip" | Out-File -FilePath dist/ndr-${{ matrix.target }}.sha256 -Encoding ASCII
          Remove-Item -Recurse dist/ndr

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ndr-${{ matrix.target }}
          path: rust/dist/ndr-*
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: ${{ github.event.inputs.tag || github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: artifacts/*
          body: |
            ## Installation

            ### Linux / macOS (auto-detect)
            ```bash
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/ndr-$(uname -m | sed 's/arm64/aarch64/')-$(uname -s | tr '[:upper:]' '[:lower:]' | sed 's/darwin/apple-darwin/' | sed 's/linux/unknown-linux-musl/').tar.gz | tar -xz && cd ndr && ./install.sh
            ```

            ### macOS (manual)
            ```bash
            # Apple Silicon (M1/M2/M3)
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/ndr-aarch64-apple-darwin.tar.gz

            # Intel Mac
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/ndr-x86_64-apple-darwin.tar.gz

            tar -xzf ndr-*.tar.gz && cd ndr && ./install.sh
            ```

            ### Linux (manual)
            ```bash
            # x86_64
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/ndr-x86_64-unknown-linux-musl.tar.gz

            # ARM64 (Raspberry Pi, etc.)
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag || github.ref_name }}/ndr-aarch64-unknown-linux-musl.tar.gz

            tar -xzf ndr-*.tar.gz && cd ndr && ./install.sh
            ```

            ### Windows
            Download `ndr-x86_64-pc-windows-msvc.zip`, extract, and add the folder to PATH.

            ### Verify
            ```bash
            ndr --help
            ```

            ## What's included
            - `ndr` — CLI for encrypted Nostr messaging
            - `install.sh` — Installer script (Unix)
            - `README.txt` — Quick reference
